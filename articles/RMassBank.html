<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RMassBank: The workflow by example • RMassBank</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="RMassBank: The workflow by example">
<meta property="og:description" content="RMassBank">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">RMassBank</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">3.11.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/RMassBank.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/RMassBankNonstandard.html">RMassBank: Non-standard usage</a>
    </li>
    <li>
      <a href="../articles/RMassBankXCMS.html">RMassBank for XCMS</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>RMassBank: The workflow by example</h1>
                        <h4 data-toc-skip class="author">Michael Stravs,
Emma Schymanski</h4>
            
      
      
      <div class="hidden name"><code>RMassBank.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><em>RMassBank</em> is a two-part computational mass spectrometry
workflow:</p>
<ul>
<li>In the first step, MSMS spectra of compounds are extracted from raw
LC-MS data files, the MSMS spectra are recalibrated using assigned
fragment formulas, and effectively denoised by using only annotated
peaks (plus peaks which can be manually added.)</li>
<li>In the second step, the processed, recalibrated, cleaned data is
prepared for submission to a MassBank database. Compounds are first
automatically annotated using information from the Chemical Translation
Service (CTS). After manually checking and fixing the annotations, the
information is compiled together with the spectral data into MassBank
records, which can then be uploaded to a MassBank database.</li>
</ul>
<p>This vignette describes basic usage with the standard workflow. The
package is flexible and allows for different advanced use cases.
Examples of specialized applications of <em>RMassBank</em> are available
at the <em>RMassBank</em> message board hosted by the
Metabolomics-Forum: (<a href="http://www.metabolomics-forum.com/viewforum.php?f=29" class="external-link uri">http://www.metabolomics-forum.com/viewforum.php?f=29</a>).</p>
</div>
<div class="section level2">
<h2 id="installation-and-loading">Installation and loading<a class="anchor" aria-label="anchor" href="#installation-and-loading"></a>
</h2>
<p>The library is available from Bioconductor ((<a href="http://www.bioconductor.org" class="external-link uri">http://www.bioconductor.org</a>)). In addition to the
library itself, it is recommended to install the OpenBabel chemical
toolkit, available from (<a href="http://www.openbabel.org" class="external-link uri">http://www.openbabel.org</a>) for various platforms (or via
Linux package distribution systems).</p>
<p>The library is loaded as follows</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">RMassBank</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: Rcpp</span></span></code></pre>
<p>The data used in the following example is available as a package
<em>RMassBankData</em>, which must be installed separately and is loaded
using</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">RMassBankData</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="input-files">Input files<a class="anchor" aria-label="anchor" href="#input-files"></a>
</h2>
<div class="section level3">
<h3 id="lcms-data">LC/MS data<a class="anchor" aria-label="anchor" href="#lcms-data"></a>
</h3>
<p><em>RMassBank</em> handles high-resolution LC/MS spectra in mzML
format in centroid<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> or in profile mode.</p>
<p>Data in the examples was acquired using an LTQ Orbitrap XL instrument
in profile mode, and converted from profile-mode RAW into centroid-mode
mzML using MSConvertGUI from ProteoWizard. The settings were as shown in
the screenshot below (note the “Peak Picking” filter.) <img src="graphics/proteowiz.PNG" alt="fig:proteowiz"></p>
<p><em>Fig. 1: ProteoWiz settings for conversion to mzML</em></p>
<p>In the standard workflow, the file names are used to identify a
compound: file names must be in the format
<code>xxxxxxxx_1234_xxx.mzXML</code>, where the xxx parts denote
anything and the 1234 part denotes the compound ID in the compound list
(see below). Advanced and alternative uses can be implemented; consult
the implementation of <code>msms_workflow</code> and
<code>findMsMsHR</code> for more information.</p>
</div>
<div class="section level3">
<h3 id="compound-list">Compound list<a class="anchor" aria-label="anchor" href="#compound-list"></a>
</h3>
<p>A compound list in CSV format is required to identify all compounds
unambiguously. The CSV file is required to have at least the following
columns, which are used for further processing and must be named
correctly (but present in any order):
<code>ID, Name, SMILES, RT, CAS</code>. The columns <code>ID</code> and
<code>SMILES</code> must be filled, the other columns must be present in
the file but do not need to be filled. <code>ID</code> specifies an
(arbitrary) numeric ID code which must be &lt; 4 digits long;
<code>SMILES</code> specifies a SMILES code with the chemical structure
of the compound (and is used to extract the molecular formula, for
calculation of molecular masses, for database searching in CTS etc.)
Although the columns <code>Name, RT, CAS</code> have to be present, the
information in the columns is only used if the cells are filled. RT, if
present, specifies the retention time (in minutes; <span class="math inline">\(\pm\)</span> a window specified in the RMassBank
options, see below) where a LC/MS file is searched for the compound
spectra. <code>CAS</code> and <code>Name</code> are used as additional
information while retrieving annotations from CTS. The compound list
doesn’t have to be ordered in any particular way. It can contain large
numbers of compounds, even compounds which will not be actively used by
the script (Note: Unused compounds don’t require a SMILES code, since
they will not be accessed.)</p>
<p>An example list is provided with the <em>RMassBankData</em> package,
and can be copied into a local folder, viewed and edited:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.copy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"list/NarcoticsDataset.csv"</span>, </span>
<span>    package<span class="op">=</span><span class="st">"RMassBankData"</span><span class="op">)</span>, <span class="st">"./Compoundlist.csv"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="settings">Settings<a class="anchor" aria-label="anchor" href="#settings"></a>
</h3>
<p>A number of different settings influence RMassBank. They are partly
parameters for data processing and partly constants used for
annotation.</p>
<p>A settings template file, to be edited by hand, can be generated
using</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/RmbDefaultSettings.html">RmbSettingsTemplate</a></span><span class="op">(</span><span class="st">"mysettings.ini"</span><span class="op">)</span></span></code></pre></div>
<p>where <code>mysettings.ini</code> is the file that will be generated.
This file should then be edited. Important settings are:</p>
<ul>
<li>
<code>deprofile</code>: Whether to use a deprofiling algorithm to
work with profile-mode data. Default is <code>NA</code> for use with
centroid-mode data. Allowed settings for profile-mode data include
<code>deprofile.fwhm</code> (full-width half-maximum algorithm),
<code>deprofile.spline</code> (cubic spline algorithm),
<code>deprofile.localmax</code> (local maximum). See the respective help
pages for detailed information.</li>
<li>
<code>rtMargin</code>: The deviation allowed for retention times (in
minutes) when extracting spectra from raw data files.</li>
<li>
<code>rtShift</code>: The systematic retention time shift (in
minutes) in the LC-MS data compared to the values in the compound
list.</li>
<li>
<code>babeldir</code>: The directory pointing to the OpenBabel
binaries.</li>
<li>
<code>use_version</code>: which MassBank data format to use. The
default is the newer version 2; alternatively, the (deprecated) version
1 can be specified for MassBank servers running old versions of the
server software.</li>
<li>
<code>use_rean_peaks</code>: Whether or not peaks from reanalysis
should be used (see below for details.)</li>
<li>
<code>add_annotation</code>: Whether or not fragments should be
annotated with the (tentative) molecular formula in MassBank
records.</li>
<li>
<code>annotations</code>: A list of annotation data used in the
MassBank records.
<ul>
<li>
<code>authors</code>, <code>copyright</code>,
<code>publication</code>, <code>license</code>, <code>instrument</code>,
<code>instrument_type</code>, <code>compound_class</code>: values for
the corresponding MassBank fields</li>
<li>
<code>confidence_comment</code>: A commentary field about “compound
confidence” which is added like “COMMENT: CONFIDENCE standard compound”
in the MassBank record.</li>
<li>
<code>internal_id_fieldname</code>: The name for an internal ID
field in the MassBank record where to store the compound ID (in the
compound list). For <code>internal_id_fieldname</code> = “MY_ID”, the ID
will be stored like “COMMENT: MY_ID 1234”.</li>
<li>
<code>entry_prefix</code>: The prefix for MassBank accession
IDs.</li>
<li>
<code>ms_type</code>, <code>ionization</code>, <code>lc_*</code>:
Annotations for the LC and MS information fields in the MassBank
records.</li>
<li>
<code>ms_dataprocessing</code>: Tags added to describe the data
processing. In addition to the tags specified here, MS$DATA_PROCESSING:
WHOLE RMassBank will be added (corresponding to a list(“WHOLE” =
“RMassBank”) entry for this option.)</li>
</ul>
</li>
<li>
<code>annotator</code>: For advanced users: option to select your
own custom annotator. Check ?annotator.default and the source code for
details.</li>
<li>
<code>spectraList</code>: The list of data-dependent scans triggered
by a MS1 scan in their order; used for annotation of MassBank records.
See the template file for description.</li>
<li>
<code>accessionBuilderType</code>: A string (either “standard”,
“simple” or “selfDefined”) to determine how to generate MassBank record
accession numbers (optional, default: “standard”). RMassBank generates
an accession number for each record. The structure and generation of
this number varies based on <code>accessionBuilderType</code>.
<ul>
<li>“standard”: accession numbers consisting of an arbitrary number of
letters followed by a 6-digit code are generated. The letter code is
defined by <code>annotations$entry_prefix</code>, the first four digits
are given by the compound ID. The last two digits are generated from the
position of the spectrum in <code>spectraList</code> and the shift
defined in <code>accessionNumberShifts</code> for the selected ion type
(Example: the compound with ID 2112, processed in “pNa” mode ([M+Na]+),
will have accession numbers XX211233, XX211234 … etc in for the first,
second… spectrum in the data-dependent scan, if the “pNa” shift is set
to 32.)</li>
<li>“simple”: accession numbers consisting of an arbitrary number of
letters followed by a 6-digit code are generated. The letter code is
defined by <code>annotations$entry_prefix</code>, the 6 digit code is
generated from the position of the spectrum in <code>spectraList</code>
and the shift given in <code>accessionNumberStart</code>. Leading zeros
are added if necessary. (Example: accession numbers XX000043, XX000045 …
will be generated for the first, second … spectrum in the data-dependent
scan if <code>accessionNumberStart</code> is set to 32.)</li>
<li>“selfDefined”: Accession numbers are generated by a user-defined
function given in <code>accessionBuilderFile</code>. In particular,
there is no constraint on the prefix and
<code>annotations$entry_prefix</code> will be ignored, if this option is
chosen. The function definition must be in the form
<code>accessionBuilder &lt;- function(cpd, spectrm, subscan)</code>.
Note: This functionality is quite advanced. If you really want to
specify your own <code>accessionBuilder</code> instead of using the
“simple” or “standard” option, we highly encourage you to familiarize
yourself with the source code of the function
<code>.buildRecord.RmbSpectraSet</code> in <code>buildRecord.R</code>
first.</li>
</ul>
</li>
<li>
<code>accessionNumberShifts</code>: A list defining the starting
points for generating MassBank record accession numbers. This will be
used if <code>accessionBuilderType</code> is unspecified or “standard”
(see <code>accessionBuilderType</code> above).</li>
<li>
<code>accessionBuilderFile</code>: A file with a user-defined
function to generate MassBank record accession numbers. This will be
used if <code>accessionBuilderType</code> is “selfDefined” (see
<code>accessionBuilderType</code> above.)</li>
<li>
<code>accessionNumberStart</code>: An integer &lt; 1000000 defining
the starting point of MassBank record accession numbers. This will be
used if <code>accessionBuilderType</code> is “simple”. (see
<code>accessionBuilderType</code> above).</li>
<li>
<code>project</code>: A string giving the project tag, optional. If
present, this will be inclueded in the <code>PROJECT</code> field of the
record.</li>
<li>
<code>recalibrateBy</code>: Which parameter to use for
recalibration: <code>dppm</code> (recalibrate the deviation in ppm) or
<code>dmz</code> (recalibrate the m/z deviation).</li>
<li>
<code>recalibrateMS1</code>: Whether to recalibrate MS1 data points
separately from MS2 data points (<code>"separate"</code>), with the same
recalibration curve as the MS2 data points (<code>"common"</code>) or
not at all (<code>"none"</code>). Note that the MS1 datapoints points
will be used to generate the MS2 recalibration curve in all cases (since
this makes the recalibration curve in high-m/z regions better-defined)
but may be recalibrated independently themselves, if desired.</li>
<li>
<code>recalibrator</code>: Sets the functions to use for
recalibration. Defaults to
<code>list(MS1="recalibrate.loess", MS2="recalibrate.loess")</code>
which uses a Loess non-parametric fit to generate a recalibration curve.
Any custom function may be specified. The function is expected to accept
a dataset with variables <code>recalfield</code> and
<code>mzFound</code> and to return an object which can be used with
<code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>. The input <code>recalfield</code> is the value
to be estimated by recalibration - it will either contain delta ppm
values or absolute mass deviations, depending on the setting for
<code>recalibrateBy</code>. In addition to
<code>recalibrate.loess</code>, <code>recalibrate.MS1</code> is
predefined, which uses a GAM model for recalibration and appears to work
well for pure MS1 datapoints. However, common recalibration for MS1 and
MS2 appears to be the best option in general.</li>
<li>
<code>multiplicityFilter</code>: Define the multiplicity filtering
level. Default is 2, a value of 1 is off (no filtering) and &gt;2 is
harsher filtering.</li>
<li>
<code>titleFormat</code>: The title of MassBank records is a
mini-summary of the record, for example “Dinotefuran; LC-ESI-QFT; MS2;
CE: 35%; R=35000; [M+H]+”. By default, the first compound name
<code>CH$NAME</code>, instrument type <code>AC$INSTRUMENT_TYPE</code>,
MS/MS type <code>AC$MASS_SPECTROMETRY: MS_TYPE</code>, collision energy
<code>RECORD_TITLE_CE</code>, resolution
<code>AC$MASS_SPECTROMETRY: RESOLUTION</code> and precursor
<code>MS$FOCUSED_ION: PRECURSOR_TYPE</code> are used. If alternative
information is relevant to differentiate acquired spectra, the title
should be adjusted. For example, many TOFs do not have a resolution
setting. See MassBank documentation for more.</li>
<li>
<code>filterSettings</code>: A list of settings that affect the
MS/MS processing.
<ul>
<li>
<code>ppmHighMass</code>, <code>ppmLowMass</code>: values for
pre-processing, prior to recalibration. The default settings (for
e.g. Orbitrap) is 10 ppm for high mass range, 15 ppm for low mass range
(defined by <code>massRangeDivision</code>)</li>
<li>
<code>massRangeDivision</code>: The m/z value defining the split
between <code>ppmHighMass</code> and <code>ppmLowMass</code> above. The
default m/z 120 is recommended for Orbitraps.</li>
<li>
<code>ppmFine</code>: This defines the ppm cut-off post
recalibration. The default value of 5 ppm is recommended for
Orbitraps.</li>
<li>
<code>prelimCut</code>, <code>prelimCutRatio</code>: Intensity
cut-off and cut-off ratio (in % of the most intense peak) for
pre-processing. Affects peak selection for the recalibration only.
Careful: the default 1e4 for Orbitrap LTQ positive could remove all
peaks for TOF data and will remove too many peaks for Orbitrap LTQ
negative mode spectra!</li>
<li>
<code>specOkLimit</code>: MS/MS must have at least one peak above
this limit present to be processed.</li>
<li>
<code>dbeMinLimit</code>: The minimum allowable ring and double bond
equivalent (DBE) allowed for assigned formulas. Assumes maximum valences
for elements with multiple possible valences. Default is -0.5
(accounting for fragment peaks being ions).</li>
<li>
<code>satelliteMzLimit</code>, <code>satelliteIntLimit</code>:
Cut-off m/z and intensity values for satellite peak removal. All peaks
within the m/z (default 0.5) and intensity ratio (default 0.05 or 5 %)
of the respective peak will be removed. Applicable to Fourier Transform
instruments (e.g. Orbitrap).</li>
</ul>
</li>
<li>
<code>findMsMsRawSettings</code>: Parameters for adjusting the raw
data retrieval.
<ul>
<li>
<code>ppmFine</code>: The ppm error to look for the precursor in the
MS1 (parent) spectrum. Default is 10 ppm for Orbitrap.</li>
<li>
<code>mzCoarse</code>: The error to search for the precursor
specification in the MS2 spectrum. This is often only saved to 2 decimal
places and thus inaccurate and may also depend on the isolation window.
The default settings (for e.g. Orbitrap) is m/z=0.5 for
<code>mzCoarse</code>.</li>
<li>
<code>fillPrecursorScan</code>: The default value (FALSE) assumes
all necessary precursor information was available in the mzML file. A
setting of TRUE tries to fill in the precursor data scan number if it is
missing.<br>
Only tested on one case-study so far.</li>
</ul>
</li>
<li>
<code>logging_file</code>: Set a file logs should be written to. By
default, <code>logging_file</code> is not specified and all logging
information is written to STDOUT. Note: This setting will cause a static
package variable to contain the logging file. This variable is checked
by the logging functions, rather than the setting. Hence, changing the
setting manually afterwards will not change the logging file.</li>
</ul>
<p>See also the manpage <code><a href="../reference/RmbSettings.html">?RmbSettings</a></code> for a description of
all RMassBank settings.</p>
</div>
</div>
<div class="section level2">
<h2 id="the-workflow">The workflow<a class="anchor" aria-label="anchor" href="#the-workflow"></a>
</h2>
<div class="section level3">
<h3 id="mass-spectrometry-workflow">Mass spectrometry workflow<a class="anchor" aria-label="anchor" href="#mass-spectrometry-workflow"></a>
</h3>
<p>In the first part of the workflow, spectra are extracted from the
files and processed. In the following example, we will process the
narcotics spectra from the <em>RMassBankData</em> package.</p>
<p>For the workflow to work correctly, a settings file (generated as
above and edited accordingly) before must be loaded first.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/RmbDefaultSettings.html">loadRmbSettings</a></span><span class="op">(</span><span class="st">"mysettings.ini"</span><span class="op">)</span></span></code></pre></div>
<p>(Note: the template file generated by
<code><a href="../reference/RmbDefaultSettings.html">RmbSettingsTemplate()</a></code> has no OpenBabel directory specified.
Correspondingly, RMassBank will use the CACTUS service instead to
generate MOL files. For your actual use, it is strongly recommended to
install OpenBabel and specify its install directory in the settings! The
CACTUS structures are visually less appealing since they have all
hydrogen atoms explicit, and CACTUS is only a backup solution.)</p>
<p>First, create a workspace for the <code>msmsWorkflow</code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/newMsmsWorkspace.html">newMsmsWorkspace</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The full paths of the files must be loaded into the container in the
array <code>files</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"spectra"</span>, package<span class="op">=</span><span class="st">"RMassBankData"</span><span class="op">)</span>,</span>
<span>     <span class="st">".mzML"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">files</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "1_3_Chlorophenyl_piperazin_2818_pos.mzML"                       </span></span>
<span><span class="co">##  [2] "1_3_Trifluoromethylphenyl_piperazin_2819_pos.mzML"              </span></span>
<span><span class="co">##  [3] "1_Benzylpiperazin_2820_pos.mzML"                                </span></span>
<span><span class="co">##  [4] "Amitriptylin_2821_pos.mzML"                                     </span></span>
<span><span class="co">##  [5] "Amphetamin_2822_pos.mzML"                                       </span></span>
<span><span class="co">##  [6] "Benzoylecgonin_2823_pos.mzML"                                   </span></span>
<span><span class="co">##  [7] "Cocain_2817_pos.mzML"                                           </span></span>
<span><span class="co">##  [8] "Dextromethorphan_2824_pos.mzML"                                 </span></span>
<span><span class="co">##  [9] "EDDP_2_Ethyl_1_5_dimethyl_3_3_diphenylpyrrolinium_2825_pos.mzML"</span></span>
<span><span class="co">## [10] "Ephedrin_2758_pos.mzML"                                         </span></span>
<span><span class="co">## [11] "Ketamin_2826_pos.mzML"                                          </span></span>
<span><span class="co">## [12] "Mephedron_4_Methylmethcathinon_2827_pos.mzML"                   </span></span>
<span><span class="co">## [13] "Methadon_2828_pos.mzML"                                         </span></span>
<span><span class="co">## [14] "Methamphetamin_2829_pos.mzML"                                   </span></span>
<span><span class="co">## [15] "Naltrexon_2830_pos.mzML"</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># To make the workflow faster here, we use only 2 compounds:</span></span>
<span><span class="va">w</span><span class="op">@</span><span class="va">files</span> <span class="op">&lt;-</span> <span class="va">files</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span></code></pre></div>
<p>Note the position of the compound IDs in the filenames. Historically,
the “<code>pos</code>” at the end was used to denote the polarity; it is
obsolete now, but the ID must be terminated with an underscore.</p>
<p>Additionally, the compound list must be loaded using
<code>loadList</code> (here, using the formerly copied list from
<em>RMassBankData</em>):</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/loadList.html">loadList</a></span><span class="op">(</span><span class="st">"./Compoundlist.csv"</span><span class="op">)</span></span></code></pre></div>
<p>This creates a variable <code>compoundList</code> in the global
environment, which stores the compound data. Now, we can start the
complete workflow to extract [M+H]+ spectral data. The workflow standard
workflow consists of 8 steps.</p>
<p>The argument <code>archivename</code> specifies the prefix under
which to store the analyzed result files. The argument <code>mode</code>
specifies the processing mode: <code>pH</code> (positive H) specifies
[M+H]+, <code>pNa</code> specifies [M+Na]+, <code>pM</code> specifies
[M]+, <code>mH</code> and <code>mFA</code> specify [M-H]- and [M+FA]-,
respectively. (I apologize for the naming of <code>pH</code> which has
absolutely nothing to do with chemical <em>pH</em> values.)</p>
<p>Basically, this runs through the entire workflow, which is explained
in more detail below: * Step 1: using the function
<code>findMsMsHR</code>, all the files in <code>files</code> are
searched for MS2 spectra of their respective compound. The found spectra
are stored in the array <code>specs</code>. * Step 2: A molecular
formula fit is attempted for every peak, using the molecular formula of
the parent compound as limiting formula, using the function
<code>analyzeMsMs</code>. The results are stored in the array
<code>analyzedSpecs</code>. * Step 3: The analyzed spectra from the
array <code>analyzedSpecs</code> are aggregated into the list
<code>aggregatedSpecs</code>. This uses the function
<code>aggregateSpectra</code>. * Step 4: Using the function
<code>recalibrateSpectra</code>, a recalibration curve is calculated
from the peaks in <code>aggregatedSpecs</code>, and all spectra from
<code>specs</code> are recalibrated using this curve. The result is
stored in <code>recalibratedSpecs</code>. The recalibration curve is
stored in <code>rc</code>. * Step 5: The recalibrated spectra
(<code>recalibratedSpecs</code>) are re-analyzed with
<code>analyzeMsMs</code> and the results stored in
<code>analyzedRcSpecs</code>. * Step 6: The reanalyzed recalibrated
spectra are aggregated with <code>aggregateSpectra</code> into
<code>aggregatedRcSpecs</code>. Unmatched peaks in
<code>aggregatedRcSpecs</code> are cleaned from known electronic noise
using <code>cleanElnoise</code>. A backup copy of all present results is
saved as <code>archivename``.RData</code>. * Step 7: Using
<code>reanalyzeFailpeaks</code>, all unmatched peaks from spectra in
<code>aggregatedRcSpecs</code> are reanalyzed, allowing <span class="math inline">\(N_2O\)</span> as additional elements (to account
for oxidation products and <span class="math inline">\(N_2\)</span>
adducts). The results are stored in <code>reanalyzedRcSpecs</code>. A
backup copy of all present results is saved as
<code>archivename``_RA.RData</code> * Step 8: The function
<code>filterMultiplicity</code> is applied to the peaks: Peaks which
occur only once in all analyzed spectra of a compound are eliminated.
The filtered list is stored under <code>refilteredSpecs</code>, and a
final version of all results is saved as
<code>archivename``_RF.RData</code>. Additionally,
<code>filterMultiplicity</code> creates a CSV file with a list of
(relatively) high-intensity unassigned peaks with the name
<code>archivename``_Failpeaks.csv</code>, which should be manually
checked. Peaks to include must be marked with OK = 1.</p>
<p>The steps can be called individually using the <code>steps</code>
parameter of <code>msms_workflow</code>. Using the
<code>newRecalibration</code> parameter, one can specify if RMassBank
should do a new recalibration (default, <code>TRUE</code>) or use the
recalibration curve stored in <code>rc</code> (<code>FALSE</code>). This
is useful for re-using a recalibration curve in the reanalysis of the
same data in another mode: After the detection and processing of all
[M+H]+ spectra, which will be present for a large number of compounds,
one can rerun the workflow with
<code>newRecalibration = F, mode="pNa"</code> and reuse the same
calibration curve for Na adduct spectra (which on their own would be too
few for a sufficiently good recalibration curve.) The
<code>useRtLimit</code> parameter activates or deactivates the usage of
retention time constraints when searching for spectra with
<code>findMsMsHR</code>.</p>
<p>It is useful to perform the workflow in two blocks, the first being
step 1-4 and the second being 5-8. After step 4, a graph is displayed
which allows the user to visually evaluate the performance of the
recalibration. The top graphs show the distribution of the mass
deviation of MS/MS fragments from the predicted mass and the
recalibration curve calculated from them; the bottom graphs show the
mass deviation of MS precursor ions. The graph to the left is a complete
xy plot while the graph to the right is a 2D histogram (if the package
<code>gplots</code> is installed on the user’s computer).</p>
<p>TODO: Workflow execution in Chunk 10 is currently disabled, I execute
Chunk 11 instead for steps that are already done.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msmsWorkflow.html">msmsWorkflow</a></span><span class="op">(</span><span class="va">w</span>, mode<span class="op">=</span><span class="st">"pH"</span>, steps<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, archivename <span class="op">=</span> </span>
<span>                <span class="st">"pH_narcotics"</span><span class="op">)</span></span></code></pre></div>
<p><img src="RMassBank_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>The recalibration can also be plotted at a later stage:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotRecalibration.html">plotRecalibration</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span></span></code></pre></div>
<p>If you are experimenting with new datasets which might give errors,
it is advised to run the workflow step by step. This is because if an
error occurs, you will lose all intermediate results from the workflow,
which might complicate finding the errors. (E.g., if you process steps
2-4 and an error occurs in step 3, you will lose the results from step
2.)</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msmsWorkflow.html">msmsWorkflow</a></span><span class="op">(</span><span class="va">w</span>, mode<span class="op">=</span><span class="st">"pH"</span>, steps<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msmsWorkflow.html">msmsWorkflow</a></span><span class="op">(</span><span class="va">w</span>, mode<span class="op">=</span><span class="st">"pH"</span>, steps<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msmsWorkflow.html">msmsWorkflow</a></span><span class="op">(</span><span class="va">w</span>, mode<span class="op">=</span><span class="st">"pH"</span>, steps<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="co"># etc.</span></span></code></pre></div>
<p>It can be useful to check if any data is retrieved at step 1:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">w</span><span class="op">@</span><span class="va">spectra</span>,<span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="va">s</span><span class="op">@</span><span class="va">found</span><span class="op">)</span></span></code></pre></div>
<p>To check the progress through the workflow, call e.g.:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/findProgress.html">findProgress</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span></span></code></pre></div>
<p>Note that usually a recalibration curve should be done which &gt;15
compounds, and it will become smoother with more compounds. To show the
curve found with the full dataset, we can load the preprocessed dataset
from the <em>RMassBankData</em> package in another workflow
container.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># In the really evaluated workflow, we do the following:</span></span>
<span><span class="co"># we run steps 1 through 3, load the recalibration curve from a stored workflow</span></span>
<span><span class="co"># and recalibrate the data using that curve.</span></span>
<span><span class="va">storedW</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/newMsmsWorkspace.html">loadMsmsWorkspace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"results/pH_narcotics_RF.RData"</span>, </span>
<span>                package<span class="op">=</span><span class="st">"RMassBankData"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in .updateObject.RmbWorkspace.1to2(w, ..., verbose): You are</span></span>
<span><span class="co">## loading an archive from an old RMassBank version. The aggregate tables</span></span>
<span><span class="co">## are not loaded from the original object, but recomputed.</span></span></code></pre>
<pre><code><span><span class="co">## Warning in .updateObject.RmbWorkspace.1to2(w, ..., verbose): If you</span></span>
<span><span class="co">## hand-edited any aggregate table, the information might not be retained in</span></span>
<span><span class="co">## the new object.</span></span></code></pre>
<pre><code><span><span class="co">## Warning in .updateObject.RmbWorkspace.1to2(w, ..., verbose): You are</span></span>
<span><span class="co">## loading an archive from an old RMassBank version. The aggregate tables</span></span>
<span><span class="co">## are not loaded from the original object, but recomputed.</span></span></code></pre>
<pre><code><span><span class="co">## Warning in .updateObject.RmbWorkspace.1to2(w, ..., verbose): If you</span></span>
<span><span class="co">## hand-edited any aggregate table, the information might not be retained in</span></span>
<span><span class="co">## the new object.</span></span></code></pre>
<pre><code><span><span class="co">## Warning in .updateObject.RmbWorkspace.1to2(w, ..., verbose): You are</span></span>
<span><span class="co">## loading an archive from an old RMassBank version. The multiplicity</span></span>
<span><span class="co">## filtering results are not loaded from the original object, but</span></span>
<span><span class="co">## recomputed.</span></span></code></pre>
<pre><code><span><span class="co">## Warning in .updateObject.RmbWorkspace.1to2(w, ..., verbose): If you</span></span>
<span><span class="co">## hand-edited any multiplicity filtering results, the information might not</span></span>
<span><span class="co">## be retained in the new object.</span></span></code></pre>
<p>Since this recalibration curve was calculated from a MassBank run of
the whole 15 file-dataset, we can copy it into our workspace and use it
to recalibrate our data without making a new recalibration curve:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Just to display the recalibration curve as calculated from</span></span>
<span><span class="co"># the complete dataset:</span></span>
<span><span class="va">storedW</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msmsWorkflow.html">msmsWorkflow</a></span><span class="op">(</span><span class="va">storedW</span>, mode<span class="op">=</span><span class="st">"pH"</span>, steps<span class="op">=</span><span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><img src="RMassBank_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Copy the recalibration to workspace w and apply it</span></span>
<span><span class="co"># (no graph displayed here)</span></span>
<span><span class="va">w</span><span class="op">@</span><span class="va">rc</span> <span class="op">&lt;-</span> <span class="va">storedW</span><span class="op">@</span><span class="va">parent</span><span class="op">@</span><span class="va">rc</span></span>
<span><span class="va">w</span><span class="op">@</span><span class="va">rc.ms1</span> <span class="op">&lt;-</span> <span class="va">storedW</span><span class="op">@</span><span class="va">parent</span><span class="op">@</span><span class="va">rc.ms1</span></span>
<span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msmsWorkflow.html">msmsWorkflow</a></span><span class="op">(</span><span class="va">w</span>, mode<span class="op">=</span><span class="st">"pH"</span>, steps<span class="op">=</span><span class="fl">4</span>, archivename <span class="op">=</span> </span>
<span>    <span class="st">"pH_narcotics"</span>, newRecalibration <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>The second part of the workflow can then be processed:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msmsWorkflow.html">msmsWorkflow</a></span><span class="op">(</span><span class="va">w</span>, mode<span class="op">=</span><span class="st">"pH"</span>, steps<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span>, archivename <span class="op">=</span> </span>
<span>        <span class="st">"pH_narcotics"</span><span class="op">)</span></span></code></pre></div>
<p>If the workflow is performed manually, the results can be stored at
any time using</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/archiveResults.html">archiveResults</a></span><span class="op">(</span><span class="va">w</span>, <span class="va">filename</span><span class="op">)</span></span></code></pre></div>
<p>where the former writes the results to a file and the latter
duplicates the R objects with a prefix in front of their names. (Note
that during the whole workflow, the results are stored automatically
after steps 6, 7, and 8 if an <code>archivename</code> is given. So the
<code>archivename</code>) parameter is only pro forma for the steps 1-5,
but can be added for consistency.</p>
<p>Result files from the workflow on the <em>RMassBankData</em>
narcotics spectra dataset are included in <em>RMassBankData</em>,
including a marked <code>Failpeaks.csv</code> list.</p>
</div>
<div class="section level3">
<h3 id="massbank-record-workflow">MassBank record workflow<a class="anchor" aria-label="anchor" href="#massbank-record-workflow"></a>
</h3>
<p>An analyzed spectral dataset can then be processed to produce
MassBank records. This is done in two major steps: First, annotations
for all compounds are retrieved from the Internet, if they are not
already present from previously compiled spectra (e.g. if an Internet
annotation has already been used to create a [M+H]+ spectrum, it can be
reused in the [M-H]- spectrum automatically.)</p>
<p>First, a workspace for the MassBank results must be created starting
from processed <code>msmsWorkflow</code> results, and potential
pre-existing infolists must be loaded.</p>
<p>To illustrate the workflow, a half-complete annotation list is
included in <em>RMassBankData</em>.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/newMbWorkspace.html">newMbWorkspace</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span></span>
<span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loadInfolists.html">resetInfolists</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span></span>
<span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loadInfolists.html">loadInfolists</a></span><span class="op">(</span><span class="va">mb</span>, <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"infolists_incomplete"</span>,</span>
<span>        package<span class="op">=</span><span class="st">"RMassBankData"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Usually, one would call the function with a personal folder:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loadInfolists.html">resetInfolists</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span></span>
<span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loadInfolists.html">loadInfolists</a></span><span class="op">(</span><span class="va">mb</span>, <span class="va">my_folder_with_csv_infolists_inside</span><span class="op">)</span></span></code></pre></div>
<p>If we checked the <code>Failpeaks.csv</code> from the previous step
and found some important peaks we want to add manually, we can do so and
load the peaks into the <code>additional_peaks</code> array:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addPeaks.html">addPeaks</a></span><span class="op">(</span><span class="va">mb</span>, <span class="va">my_corrected_Failpeaks.csv</span><span class="op">)</span></span></code></pre></div>
<p>Now, the record generation workflow can be started:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mbWorkflow.html">mbWorkflow</a></span><span class="op">(</span><span class="va">mb</span>, infolist_path<span class="op">=</span><span class="st">"./Narcotics_infolist.csv"</span><span class="op">)</span></span></code></pre></div>
<p>For all the compounds which were not in the infolists in the
<code>infolists_incomplete</code> folder, an entry is fetched and
written to <code>Narcotics_infolist.csv</code> (if no infolist_path is
specified, the default path is <code>./infolist.csv</code>.) This file
should then be edited and fixed by hand. The entries don’t have to be
complete; mandatory fields are: at least 1 name, the formula, the exact
mass, SMILES code, InChI standard code, InChI standard key. Common
errors which must be fixed by hand: 2 near-identical names in the
infolist; a very high ChemSpider ID where a lower one exists (which is
“better”), a ChEBI entry saying “ChEBI” instead of the actual ChEBI
code.</p>
<p>CAUTION: At this stage the compound name is taken from the
user-provided compound list and one IUPAC entry from CTS. Please check
your compound list carefully! The original naming system from CTS will
be reinstated once the scoring system is re-included in the new
services.</p>
<p>After fixing the CSV infolist, it should be copied into the infolist
folder and the infolist reloaded:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loadInfolists.html">resetInfolists</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span></span>
<span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loadInfolists.html">loadInfolists</a></span><span class="op">(</span><span class="va">mb</span>, <span class="va">my_folder_with_csv_infolists_inside</span><span class="op">)</span></span></code></pre></div>
<p>For simplicity / easy testing, a full list for the narcotics dataset
is included in <em>RMassBankData</em>:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loadInfolists.html">resetInfolists</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span></span>
<span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loadInfolists.html">loadInfolists</a></span><span class="op">(</span><span class="va">mb</span>, <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"infolists"</span>, package<span class="op">=</span><span class="st">"RMassBankData"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>When we run the workflow again, the line “no new data added” means
that the infolists were complete and the workflow can therefore
continue.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mbWorkflow.html">mbWorkflow</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span></span></code></pre></div>
<p>The workflow goes through the following steps: * Step 1: For compound
IDs not in a loaded infolist, new data is fetched from the CTS using the
function <code>gather.data</code> and stored in <code>mbdata</code> in
tree-like format. * Step 2: If new data was retrieved, it is exported to
the <code>infolist_path</code> in flat-table format and the workflow
stops, otherwise the workflow continues. * Step 3: The infolists loaded
with <code>loadInfolists</code> are transformed into tree-like MassBank
compound information with <code>readMbdata</code> and stored as
<code>mbdata_relisted</code>. * Step 4: Using the function
<code>compileRecords</code>, the compound information from
<code>mbdata_relisted</code> is combined with the spectral data and peak
lists from <code>aggregatedRcSpecs</code> and
<code>refilteredRcSpecs</code> to create compiled records (stored in
<code>compiled</code>). All compiled records with at least one good
spectrum per compound are in <code>compiled_ok</code>. * Step 5: The
function <code>toMassbank</code> converts the records into text-file
arrays, stored in <code>mbfiles</code>. * Step 6: Molfiles are generated
for all compounds using <code>createMolfile</code> and stored in
<code>molfiles</code>. * Step 7: The data stored in the R variables
<code>mbfiles</code> and <code>molfiles</code> is written to physical
files using <code>exportMassbank</code> in a subfolder named after the
MassBank entry prefix. * Step 8: A <code>list.tsv</code> file is created
using <code>makeMollist</code>.</p>
<p>Subsequently, the two folders <code>moldata</code> and
<code>recdata</code> can be zipped and uploaded. This wasn’t automated
because the Windows version of <code>zip</code> needs additional
installed tools.</p>
<p>Note: here, step 6 uses molfile data generated by CACTUS. As stated
above, it is strongly recommended to install OpenBabel and add its path
to the configuration file for use in <code>mbWorkflow</code> step 6.</p>
</div>
</div>
<div class="section level2">
<h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.3.0 (2023-04-21)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu (64-bit)</span></span>
<span><span class="co">## Running under: Ubuntu 22.04.2 LTS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">## LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so;  LAPACK version 3.10.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=en_US.UTF-8          LC_NUMERIC=C                 </span></span>
<span><span class="co">##  [3] LC_TIME=en_US.UTF-8           LC_COLLATE=en_US.UTF-8       </span></span>
<span><span class="co">##  [5] LC_MONETARY=en_US.UTF-8       LC_MESSAGES=en_US.UTF-8      </span></span>
<span><span class="co">##  [7] LC_PAPER=en_US.UTF-8          LC_NAME=en_US.UTF-8          </span></span>
<span><span class="co">##  [9] LC_ADDRESS=en_US.UTF-8        LC_TELEPHONE=en_US.UTF-8     </span></span>
<span><span class="co">## [11] LC_MEASUREMENT=en_US.UTF-8    LC_IDENTIFICATION=en_US.UTF-8</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: UTC</span></span>
<span><span class="co">## tzcode source: system (glibc)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">## [1] RMassBankData_1.38.0 RMassBank_3.11.1     Rcpp_1.0.10         </span></span>
<span><span class="co">## [4] BiocStyle_2.28.0    </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##   [1] rcdklibs_2.8          DBI_1.1.3             bitops_1.0-7         </span></span>
<span><span class="co">##   [4] gridExtra_2.3         logger_0.2.2          rlang_1.1.1          </span></span>
<span><span class="co">##   [7] magrittr_2.0.3        clue_0.3-64           compiler_4.3.0       </span></span>
<span><span class="co">##  [10] png_0.1-8             systemfonts_1.0.4     vctrs_0.6.2          </span></span>
<span><span class="co">##  [13] rvest_1.0.3           stringr_1.5.0         ProtGenerics_1.32.0  </span></span>
<span><span class="co">##  [16] pkgconfig_2.0.3       fastmap_1.1.1         caTools_1.18.2       </span></span>
<span><span class="co">##  [19] readJDX_0.6.1         utf8_1.2.3            rmarkdown_2.21       </span></span>
<span><span class="co">##  [22] preprocessCore_1.62.1 itertools_0.1-3       ragg_1.2.5           </span></span>
<span><span class="co">##  [25] purrr_1.0.1           xfun_0.39             zlibbioc_1.46.0      </span></span>
<span><span class="co">##  [28] cachem_1.0.8          ChemmineR_3.52.0      jsonlite_1.8.4       </span></span>
<span><span class="co">##  [31] highr_0.10            BiocParallel_1.34.0   data.tree_1.0.0      </span></span>
<span><span class="co">##  [34] parallel_4.3.0        cluster_2.1.4         R6_2.5.1             </span></span>
<span><span class="co">##  [37] bslib_0.4.2           stringi_1.7.12        limma_3.56.0         </span></span>
<span><span class="co">##  [40] jquerylib_0.1.4       bookdown_0.33         assertthat_0.2.1     </span></span>
<span><span class="co">##  [43] iterators_1.0.14      knitr_1.42            base64enc_0.1-3      </span></span>
<span><span class="co">##  [46] R.utils_2.12.2        IRanges_2.34.0        tidyselect_1.2.0     </span></span>
<span><span class="co">##  [49] rcdk_3.7.0            yaml_2.3.7            gplots_3.1.3         </span></span>
<span><span class="co">##  [52] doParallel_1.0.17     codetools_0.2-19      affy_1.78.0          </span></span>
<span><span class="co">##  [55] curl_5.0.0            lattice_0.21-8        tibble_3.2.1         </span></span>
<span><span class="co">##  [58] plyr_1.8.8            Biobase_2.60.0        evaluate_0.20        </span></span>
<span><span class="co">##  [61] desc_1.4.2            rJava_1.0-6           xml2_1.3.4           </span></span>
<span><span class="co">##  [64] pillar_1.9.0          affyio_1.70.0         BiocManager_1.30.20  </span></span>
<span><span class="co">##  [67] KernSmooth_2.23-20    DT_0.27               foreach_1.5.2        </span></span>
<span><span class="co">##  [70] stats4_4.3.0          MSnbase_2.26.0        MALDIquant_1.22.1    </span></span>
<span><span class="co">##  [73] ncdf4_1.21            generics_0.1.3        rprojroot_2.0.3      </span></span>
<span><span class="co">##  [76] RCurl_1.98-1.12       S4Vectors_0.38.1      ggplot2_3.4.2        </span></span>
<span><span class="co">##  [79] munsell_0.5.0         scales_1.2.1          gtools_3.9.4         </span></span>
<span><span class="co">##  [82] glue_1.6.2            webchem_1.2.0         tools_4.3.0          </span></span>
<span><span class="co">##  [85] data.table_1.14.8     mzID_1.38.0           vsn_3.68.0           </span></span>
<span><span class="co">##  [88] mzR_2.35.1            fs_1.6.2              XML_3.99-0.14        </span></span>
<span><span class="co">##  [91] grid_4.3.0            impute_1.74.1         fingerprint_3.5.7    </span></span>
<span><span class="co">##  [94] MsCoreUtils_1.12.0    colorspace_2.1-0      cli_3.6.1            </span></span>
<span><span class="co">##  [97] textshaping_0.3.6     rsvg_2.4.0            fansi_1.0.4          </span></span>
<span><span class="co">## [100] dplyr_1.1.2           pcaMethods_1.92.0     gtable_0.3.3         </span></span>
<span><span class="co">## [103] R.methodsS3_1.8.2     sass_0.4.5            digest_0.6.31        </span></span>
<span><span class="co">## [106] BiocGenerics_0.46.0   htmlwidgets_1.6.2     rjson_0.2.21         </span></span>
<span><span class="co">## [109] memoise_2.0.1         htmltools_0.5.5       pkgdown_2.0.7.9000   </span></span>
<span><span class="co">## [112] R.oo_1.25.0           lifecycle_1.0.3       httr_1.4.5           </span></span>
<span><span class="co">## [115] MASS_7.3-59</span></span></code></pre>
</div>
<div class="footnotes footnotes-end-of-document">
<hr>
<ol>
<li id="fn1"><p>The term “centroid” here refers to any kind of data
which are not in profile mode, i.e. don’t have continuous m/z data. It
does not refer to the (mathematical) centroid peak, i.e. the
area-weighted mass peak.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by RMassBank at Eawag, Michael A. Stravs, Emma L. Schymanski, Steffen Neumann, Erik Muller, Paul Stahlhofen.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.9000.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
